<!DOCTYPE html>
<html lang="es" xml:lang="es">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<title>Consola</title>

	<link rel="manifest" href="/manifest.json">

	<meta name="theme-color" content="#212121">
	<meta name="msapplication-navbutton-color" content="#212121">
	<meta name="apple-mobile-web-app-status-bar-style" content="#212121">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<link rel="apple-touch-icon" href="/images/app/ic_launcher192.png">

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

	<!-- Font Awesome -->
	<link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="/adminlte/css/adminlte.min.css">
	<!-- Pace progress -->
	<link rel="stylesheet" href="/plugins/pace-progress/themes/red/pace-theme-minimal.css">
	<!-- Toastr -->
	<link rel="stylesheet" href="/plugins/toastr/toastr.min.css">
	<!-- MCDatePicker -->
	<link href="https://cdn.jsdelivr.net/npm/mc-datepicker/dist/mc-calendar.min.css" rel="stylesheet" />
	<!-- icheck bootstrap -->
	<link rel="stylesheet" href="/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
	<!-- Main css -->
	<link rel="stylesheet" href="/css/console.css">
</head>
<!--  layout-navbar-fixed text-sm -->

<body class="hold-transition sidebar-mini sidebar-collapse layout-fixed no-seleccionable">
	<!-- Site wrapper -->
	<div class="wrapper">
		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-dark">
			<!-- Left navbar links -->
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link d-block d-md-block d-lg-none" data-widget="pushmenu" href="#" role="button"><i
							class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item d-none d-sm-inline-block">
					<a class="nav-link">
						<%= username %>
					</a>
				</li>
			</ul>
			<!-- Right navbar links  -->
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<div class="nav-link">
						<%=deviceName%>
					</div>
				</li>
				<!-- Notifications Dropdown Menu -->
				<li class="nav-item">
					<a class="notifications nav-link" href="#" role="button">
						<i class="far fa-bell"></i>
						<span id="notificationCount" class="badge badge-danger navbar-badge" style="display: none;">0</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="fullscreen" href="#" role="button">
						<i class="fas fa-expand-arrows-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" onclick="logout()" href="#" role="button">
						<i class="fas fa-sign-out-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
		</nav>
		<!-- /.navbar -->
		<!-- Left side column. contains the logo and sidebar -->
		<aside class="main-sidebar sidebar-dark-primary elevation-1">
			<!-- Brand Logo -->
			<a href="#" class="brand-link">
				<img src="/images/app/ic_launcher96.png" alt="LOGO" class="brand-image" style="opacity: .8">
				<span class="brand-text font-weight-light">LOGO</span>
			</a>
			<!-- sidebar: style can be found in sidebar.less -->
			<div class="sidebar os-host-overflow os-host-overflow-y">
				<!-- Sidebar Menu -->
				<%- include('./complements/sidebar_menu.ejs') %>
			</div>
			<!-- /.sidebar -->
		</aside>
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<%- include('./complements/devices.ejs') %>
				<!-- Lista de dispositivos cargada desde el inicio como parte de la consola -->
		</div>
		<!-- /.content-wrapper -->

		<footer class="main-footer">
			<div class="float-right d-none d-sm-block">
				<b>Version</b> 4.1
			</div>
			<strong>Copyright &copy; 2018-2022 <a href="#">Leder Diez</a>.</strong> All rights reserved.
		</footer>

		<!-- Control Sidebar -->
		<%- include('../models/configs/' + modelName + '/configs.ejs' ) %>

		<%- include('./complements/edit_user.ejs') %>
		<%- include('./complements/edit_device.ejs') %>
		<%- include('./complements/delete_device.ejs') %>
		<%- include('./complements/add_device.ejs') %>
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="/plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- Pace progress -->
	<script src="/plugins/pace-progress/pace.min.js"></script>
	<!-- FastClick -->
	<script src="/plugins/fastclick/fastclick.js"></script>
	<!-- Toastr -->
	<script src="/plugins/toastr/toastr.min.js"></script>
	<!-- MCDatePicker -->
	<script src="https://cdn.jsdelivr.net/npm/mc-datepicker/dist/mc-calendar.min.js"></script>
	<!-- AdminLTE App -->
	<script src="/adminlte/js/adminlte.min.js"></script>

	<!-- Highcharts -->
	<script src="/plugins/Highcharts-Stock/highstock.js"></script>
	<script src="/plugins/Highcharts/highcharts-more.js"></script>
	<script src="/plugins/Highcharts/modules/solid-gauge.js"></script>
	<script src="/plugins/Highcharts/modules/exporting.js"></script>
	<script src="/plugins/Highcharts/modules/export-data.js"></script>
	<script src="/plugins/Highcharts/modules/accessibility.js"></script>
	<script src="/plugins/Highcharts/modules/drilldown.js"></script>
	<!-- Snap svg -->
	<script src="/plugins/snap-svg/snap.svg-min.js"></script>
	<!-- Grafica -->
	<script src="/js/Graphics.js"></script>
	<!-- Paho MQTT -->
	<script src="/js/paho-mqtt.js"></script>

	<script type="text/javascript">

		toastr.options = {
			"closeButton": true,
			"debug": false,
			"newestOnTop": true,
			"progressBar": false,
			"positionClass": "toast-bottom-right",
			"preventDuplicates": false,
			"onclick": null,
			"showDuration": "10000",
			"hideDuration": "1000",
			"timeOut": "10000",
			"extendedTimeOut": "1000"
		};

		var connection;

		let loadedPages = ['devices'];
		let currentPage = "something";
		let container = $('.content-wrapper');

		let lastNotificationCount = 0;

		function getRandomInt(min, max) {
			return Math.round(Math.random() * (max - min)) + min;
		}

		function getRandomFloat(min, max) {
			return (Math.random() * (max - min) + min).toFixed(1);
		}

		$(".dashboard").click( function() { loadView($(this).attr("class")); });
		$(".historical").click( function() { loadView($(this).attr("class")); });
		$(".comparisons").click( function() { loadView($(this).attr("class")); });
		$(".notifications").click( function() { loadView($(this).attr("class")); });
		$(".devices").click( function() { loadView($(this).attr("class")); });
		$(".options").click( function() { loadView($(this).attr("class")); });

		function loadView(view) {
			view = view.replace(' nav-link', '') // OJO con los menus
			view = view.replace(' active', '') //

			$('[data-widget="pushmenu"]').PushMenu('collapse');

			if ($("#" + view).length) {
				if (currentPage !== view) {
					for (let i = 0; i < loadedPages.length; i++) {
						if (loadedPages[i] !== view) {
							$("#" + loadedPages[i]).css("display", "none");

							var event = new Event("OnInvisible", { bubbles: true });
							document.getElementById(loadedPages[i]).dispatchEvent(event);
						} else {
							$("#" + loadedPages[i]).css("display", "block");

							var event = new Event("OnVisible", { bubbles: true });
							document.getElementById(loadedPages[i]).dispatchEvent(event);
						}
					}
					$('.' + currentPage).removeClass("active");
					$('.' + view).addClass("active");
					currentPage = view;
					window.localStorage.setItem("localLastPage", currentPage);
				}
			} else {
				Pace.restart();
				$.post({
					url: "/models/",
					data: {
						'viewName': view
					},
					success: (result) => {
						$(container).append(result);
						loadedPages.push(view);
						for (let i = 0; i < loadedPages.length; i++) {
							if (loadedPages[i] !== view) {
								$("#" + loadedPages[i]).css("display", "none");

								var event = new Event("OnInvisible", { bubbles: true });
								document.getElementById(loadedPages[i]).dispatchEvent(event);
							}
						}
						$('.' + currentPage).removeClass("active");
						$('.' + view).addClass("active");
						currentPage = view;
						window.localStorage.setItem("localLastPage", currentPage);
					}, error: (xhr, ajaxOptions, thrownError) => {
						toastr.error('Tenemos problemas para procesar las peticiones.', 'Error!');
					}
				});
			}
		}

		// Muestra mensajes y aplica respuestas enviadas desde el servidor.
		function processResponse(response) {
			if (response.status == "success") {
				toastr.success(response.message, response.title);
			} else if (response.status == "error") {
				toastr.error(response.message, response.title);
			} else {
				toastr.error('Tenemos problemas para procesar las peticiones.', 'Error!');
				return;
			}
			if (response.action == "show") {
				setTimeout(() => {
					loadView(response.toShow);
				}, 2000);
			} else if (response.action == "redirect") {
				setTimeout(() => {
					window.location.replace(response.redirectTo);
				}, 2000);
			} else if (response.action == "reload") {
				setTimeout(() => {
					window.location.reload();
				}, 2000);
			} else if (response.action == "logout") {
				setTimeout(() => {
					logout();
				}, 2000);
			}
		}

		function logout() {
			Pace.restart();
			$.post("../v1/acceso/logout", {}, (response, status) => {
				processResponse(response);
			});
		}

		function checkNotifications() {
			Pace.restart();
			$.get("../v1/notifications/count", {}, (response, status) => {
				if (lastNotificationCount != response.count) {
					let indicator = document.getElementById("notificationCount");
					indicator.innerHTML = response.count;
					indicator.style.display = "block";
					//Reproducir un sonido?
				}
				lastNotificationCount = response.count;
			});
		}

		(function () {
			if (parseInt("<%=devices.length%>", 10) > 0) {
				var localLastPage = 'devices'
				if (window.localStorage.getItem("localLastPage") != null) {
					localLastPage = window.localStorage.getItem("localLastPage");
				}
				loadView(localLastPage);
			} else {
				$("#modal-add-device").modal({ backdrop: 'static', keyboard: true });
			}

			checkNotifications();

			setInterval(() => {
				checkNotifications();
			}, 60000); //Cada minuto?
		})();

		function urlB64ToUint8Array(base64String) {
			const padding = '='.repeat((4 - base64String.length % 4) % 4);
			const base64 = (base64String + padding)
				.replace(/\-/g, '+')
				.replace(/_/g, '/')
				;

			const rawData = window.atob(base64);
			const outputArray = new Uint8Array(rawData.length);

			for (let i = 0; i < rawData.length; ++i) {
				outputArray[i] = rawData.charCodeAt(i);
			}
			return outputArray;
		}

		async function subscriber(subscription) {
			await fetch('../v1/notifications/sub', {
				method: 'POST',
				body: JSON.stringify(subscription),
				headers: {
					'Content-Type': 'application/json'
				}
			});
		}

		(function () {

			const PUBLIC_VAPID_KEY = 'BAf1El6wjuEPkx_T5kv508f61NdhHbbsvsYTsjBoDwuSVk9xcsGJzyRB4DzFy6BA5ExI9sfm9KpwY4sFHGb_U68';
			if ('serviceWorker' in navigator && 'PushManager' in window) {
				window.addEventListener('load', () => {
					console.log('Service Worker and Push is supported');
					navigator.serviceWorker.register('../service-worker.js', { scope: "/", }).then((swReg) => {
						console.log('Service Worker is registered', swReg);

						if (swReg) {

							if (Notification.permission === 'denied') {
								console.log('Push Messaging Blocked.');
								return;
							}

							const applicationServerKey = urlB64ToUint8Array(PUBLIC_VAPID_KEY);
							swReg.pushManager.subscribe({
								userVisibleOnly: true,
								applicationServerKey: applicationServerKey
							}).then((subscription) => {
								console.log('User is subscribed:', subscription);

								subscriber(subscription).then();

							}).catch((err) => {
								console.log('Failed to subscribe the user: ', err);
							});
						}

					}).catch((error) => {
						console.error('Service Worker Error', error);
					});
				});
			} else {
				console.warn('Push messaging is not supported');
			}
			
		})();
	</script>

</body>

</html>