<!DOCTYPE html>
<html lang="es" xml:lang="es">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<title>Consola</title>

	<link rel="manifest" href="../manifest.json">

	<meta name="theme-color" content="#212121">
	<meta name="msapplication-navbutton-color" content="#212121">
	<meta name="apple-mobile-web-app-status-bar-style" content="#212121">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

	<!-- Font Awesome -->
	<link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="../adminlte/css/adminlte.min.css">
	<!-- Pace progress -->
	<link rel="stylesheet" href="../plugins/pace-progress/themes/red/pace-theme-minimal.css">
	<!-- Toastr -->
	<link rel="stylesheet" href="../plugins/toastr/toastr.min.css">
	<!-- MCDatePicker -->
	<link href="https://cdn.jsdelivr.net/npm/mc-datepicker/dist/mc-calendar.min.css" rel="stylesheet" />
	<!-- Main css -->
	<link rel="stylesheet" href="../css/console.css">
</head>
<!--  layout-navbar-fixed text-sm -->
<body class="hold-transition sidebar-mini sidebar-collapse layout-fixed">
	<!-- Site wrapper -->
	<div class="wrapper">
		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-dark">
			<!-- Left navbar links -->
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link d-block d-md-block d-lg-none" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item d-none d-sm-inline-block">
					<a class="nav-link"><%= user %></a>
				</li>
			</ul>
			<!-- Right navbar links  -->
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<div class="nav-link">
						<p class="d-none d-md-inline"><%=deviceName%></p>
					</div>
				</li>
				<!-- Notifications Dropdown Menu -->
				<li class="nav-item">
					<a class="notifications nav-link" href="#" role="button">
						<i class="far fa-bell"></i>
						<span class="badge badge-danger navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="fullscreen" href="#" role="button">
						<i class="fas fa-expand-arrows-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" onclick="logout();" href="#" role="button">
						<i class="fas fa-sign-out-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
		</nav>
		<!-- /.navbar -->
		<!-- Left side column. contains the logo and sidebar -->
		<aside class="main-sidebar sidebar-dark-primary elevation-1">
			<!-- Brand Logo -->
			<a href="#" class="brand-link">
				<img src="../images/app/ic_launcher96.png" alt="LOGO" class="brand-image" style="opacity: .8">
				<span class="brand-text font-weight-light">LOGO</span>
			</a>
			<!-- sidebar: style can be found in sidebar.less -->
			<div class="sidebar os-host-overflow os-host-overflow-y">
				<!-- Sidebar Menu -->
				<nav class="mt-2">
					<ul class="nav nav-pills nav-sidebar flex-column nav-legacy nav-child-indent" data-widget="treeview" role="menu" data-accordion="false">
						<!-- Add icons to the links using the .nav-icon class with font-awesome or any other icon font library -->
						<!-- ----------------------------------------------------------------------------------------- -->
						<li class="nav-item">
							<a href="#" class="dashboard nav-link">
								<i class="nav-icon fas fa-tachometer-alt"></i>
								<p>Tablero</p>
							</a>
						</li>
						<!-- ----------------------------------------------------------------------------------------- -->
						<li class="nav-item">
							<a href="#" class="historical nav-link">
								<i class="nav-icon fas fa-chart-bar"></i>
								<p>Estadisticas</p>
							</a>
						</li>
						<!-- ----------------------------------------------------------------------------------------- -->
						<li class="nav-item">
							<a href="#" class="comparisons nav-link">
								<i class="nav-icon far fa-clone"></i>
								<p>Comparaciones</p>
							</a>
						</li>
						<!-- ----------------------------------------------------------------------------------------- -->
						<li class="nav-item">
							<a href="#" class="notifications nav-link">
								<i class="nav-icon far fa-bell"></i>
								<p>Notificaciones</p>
							</a>
						</li>
						<!-- ----------------------------------------------------------------------------------------- -->
						<li class="nav-item">
							<a href="#" class="options nav-link">
								<i class="nav-icon far fa-image"></i>
								<p>Opciones</p>
							</a>
						</li>
						<li class="nav-header">Redes sociales</li>
						<li class="nav-item">
							<a href="#" class="nav-link">
								<i class="nav-icon far fa-circle text-danger"></i>
								<p class="text">YouTube</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="#" class="nav-link">
								<i class="nav-icon far fa-circle text-warning"></i>
								<p>Twitter</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="#" class="nav-link">
								<i class="nav-icon far fa-circle text-info"></i>
								<p>Facebook</p>
							</a>
						</li>
					</ul>
				</nav>
			</div>
			<!-- /.sidebar -->
		</aside>
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
		</div>
		<!-- /.content-wrapper -->
		<footer class="main-footer">
			<div class="float-right d-none d-sm-block">
				<b>Version</b> 4.0
			</div>
			<strong>Copyright &copy; 2018-2021 <a href="#">Leder Diez</a>.</strong> All rights reserved.
		</footer>

		<%- include ./modals/edit_user.ejs   %>
		<%- include ./modals/edit_device.ejs   %>
		<%- include ./modals/delete_device.ejs %>
		<%- include ./modals/add_device.ejs    %>

		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
			<div class="p-3 control-sidebar-content">
				<h5>Opciones avanzadas</h5>
				<hr class="mb-2">
				<h6>Usuario</h6>
				<div
				class="mb-2" data-toggle="modal" data-target="#modal-edit-user" href="#" data-backdrop="static" data-keyboard="false" class="nav-item">
					<a href="#" class="sidebar-tree-item">
						<i class="far fa-user nav-icon"></i>
						<span class="text sidebar-tree-item-text">Modificar datos de usuario</span>
					</a>
				</div>
				<h6>Opciones de dispositivos</h6>
				<div
				class="mb-2" data-toggle="modal" data-target="#modal-add-device" data-backdrop="static" data-keyboard="false" class="nav-item">
					<a href="#" class="sidebar-tree-item">
						<i class="fas fa-plus nav-icon"></i>
						<span class="text sidebar-tree-item-text">Agregar un nuevo dispositivo</span>
					</a>
				</div>
				<% if (NDevices > 0) { %>
				<div
				class="mb-2" data-toggle="modal" data-target="#modal-edit-device" data-backdrop="static" data-keyboard="false" class="nav-item">
					<a href="#" class="sidebar-tree-item">
						<i class="far fa-edit nav-icon"></i>
						<span class="text sidebar-tree-item-text">Editar este dispositivo</span>
					</a>
				</div>
				<div
				class="mb-2" data-toggle="modal" data-target="#modal-delete-device" data-backdrop="static" data-keyboard="false" class="nav-item">
					<a href="#" class="sidebar-tree-item">
						<i class="far fa-trash-alt nav-icon"></i>
						<span class="text sidebar-tree-item-text">Eliminar este dispositivo</span>
					</a>
				</div>
				<% } %>
				<h6>Cambiar de dispositivo</h6>
				<% if (NDevices > 0) { %>
					<% for(var i = 0; i < JSON.parse(devices).length; i++) { %>
					<div class="mb-2">
						<a device="<%= i %>" onclick='changeDevice(this); return false;' href="#" class="sidebar-tree-item">
							<i class="nav-icon fas fa-desktop"></i>
							<span class="text sidebar-tree-item-text"><%= JSON.parse(devices)[i].name %></span>
						</a>
					</div>
					<% } %>
				<% } %>
			</div>
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<!-- jQuery -->
	<script src="../plugins/jquery/jquery.min.js"></script>
	<!-- Bootstrap 4 -->
	<script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- Pace progress -->
	<script src="../plugins/pace-progress/pace.min.js"></script>
	<!-- FastClick -->
	<script src="../plugins/fastclick/fastclick.js"></script>
	<!-- Toastr -->
	<script src="../plugins/toastr/toastr.min.js"></script>
	<!-- MCDatePicker -->
	<script src="https://cdn.jsdelivr.net/npm/mc-datepicker/dist/mc-calendar.min.js"></script>
	<!-- AdminLTE App -->
	<script src="../adminlte/js/adminlte.min.js"></script>

	<!-- Highcharts -->
	<script src="../plugins/Highcharts-Stock/highstock.js"></script>
	<script src="../plugins/Highcharts/highcharts-more.js"></script>
	<script src="../plugins/Highcharts/modules/solid-gauge.js"></script>
	<script src="../plugins/Highcharts/modules/exporting.js"></script>
	<script src="../plugins/Highcharts/modules/export-data.js"></script>
	<script src="../plugins/Highcharts/modules/accessibility.js"></script>
	<script src="../plugins/Highcharts/modules/drilldown.js"></script>
	<!-- Snap svg -->
	<script src="../plugins/snap-svg/snap.svg-min.js"></script>
	<!-- Grafica -->
	<script src="../js/Graphics.js"></script>

	<script type="text/javascript">

		toastr.options = {
			"closeButton": true,
			"debug": false,
			"newestOnTop": false,
			"progressBar": false,
			"positionClass": "toast-bottom-right",
			"preventDuplicates": false,
			"onclick": null,
			"showDuration": "10000",
			"hideDuration": "1000",
			"timeOut": "10000",
			"extendedTimeOut": "1000"
		};

		const DEVICE_NAME   = "<%=deviceName%>";
		const DEVICES  = parseInt("<%=NDevices%>", 10);

		var connection;

		let v         = "<%=deviceSerial%>";
		let pages     = [];
		let lastPage  = "something";
		let container = $('.content-wrapper');

		$( ".dashboard"    ).click(function() { loadView($(this).attr("class")); });
		$( ".historical"   ).click(function() { loadView($(this).attr("class")); });
		$( ".comparisons"  ).click(function() { loadView($(this).attr("class")); });
		$( ".notifications").click(function() { loadView($(this).attr("class")); });
		$( ".devices"      ).click(function() { loadView($(this).attr("class")); });
		$( ".options"      ).click(function() { loadView($(this).attr("class")); });

		function changeDevice (element) {

			var deviceID = element.getAttribute('device');
			var protocol = window.location.protocol;
			var hostname = window.location.hostname;
			var pathname = window.location.pathname;

			location.href = protocol + '//' + hostname + pathname + '?device=' + deviceID;
		}

		function loadView (page) {
			page = page.replace(' nav-link', '') // OJO con los menus
			page = page.replace(' active', '') //

			$('[data-widget="pushmenu"]').PushMenu('collapse');

			if ($("#" + page).length ) {
				if (lastPage !== page) {
					for (let i = 0; i < pages.length; i++) {
						if (pages[i] !== page) {
							$("#" + pages[i]).css( "display", "none" );
						} else {
							$("#" + pages[i]).css( "display", "block" );
						}
					}
					$('.' + lastPage).removeClass( "active" );
					$('.' + page).addClass( "active" );
					lastPage = page;
					window.localStorage.setItem("localLastPage", lastPage);
				}
			} else {
				Pace.restart();
				$.ajax({
					type: 'POST',
					url: "/models/",
					data: {
						'viewName': page
					},
					success: function(result){
						$(container).append(result);
						pages.push(page);
						for (let i = 0; i < pages.length; i++) {
							if (pages[i] !== page) {
								$("#" + pages[i]).css( "display", "none" );
							}
						}
						$('.' + lastPage).removeClass( "active" );
						$('.' + page).addClass( "active" );
						lastPage = page;
						window.localStorage.setItem("localLastPage", lastPage);
					}, error: function (xhr, ajaxOptions, thrownError) {
						toastr.error('Tenemos problemas para procesar nuestros archivos.', 'Error!');
					}
				});
			}
		}

		// Muestra mensajes y aplica respuestas enviadas desde el servidor.
		function processResponse (response) {
			if (response.status == "success") {
				toastr.success(response.message, response.title);
			} else if (response.status == "error") {
				toastr.error(response.message, response.title);
			} else {
				toastr.error('Tenemos problemas para procesar las peticiones.', 'Error!');
				return;
			}
			if (response.action == "show") {
				setTimeout( function() {
					loadView(response.toShow);
				}, 2000);
			} else if (response.action == "redirect") {
				setTimeout( function() {
					window.location.replace(response.redirectTo);
				}, 2000);
			} else if (response.action == "reload") {
				setTimeout( function() {
					window.location.reload();
				}, 2000);
			} else if (response.action == "logout") {
				setTimeout( function() {
					logout();
				}, 2000);
			}
		}

		function logout() {
			Pace.restart();
			$.post("../api/user/", {
				page : 'logout'
			},
			function(response, status){
				processResponse(response);
			});
		}

		(function () {
			if (DEVICES > 0) {
				var localLastPage = 'dashboard'
				if (window.localStorage.getItem("localLastPage") != null) {
					localLastPage = window.localStorage.getItem("localLastPage");
				}
				loadView(localLastPage);
			} else {
				$("#modal-add-device").modal({backdrop: 'static', keyboard: true});
			}
		})();

		function urlB64ToUint8Array(base64String) {
			const padding = '='.repeat((4 - base64String.length % 4) % 4);
			const base64 = (base64String + padding)
				.replace(/\-/g, '+')
				.replace(/_/g, '/')
			;

			const rawData = window.atob(base64);
			const outputArray = new Uint8Array(rawData.length);

			for (let i = 0; i < rawData.length; ++i) {
				outputArray[i] = rawData.charCodeAt(i);
			}
			return outputArray;
		}

		async function subscriber (subscription) {
			await fetch('./subscription', {
				method : 'POST',
				body : JSON.stringify(subscription),
				headers : {
					'Content-Type' : 'application/json'
				}
			});
		}

		(function(){

			const PUBLIC_VAPID_KEY = 'BIu88NQdjuLjWMNt8p4iBhnvaksI3bOTlNOLlNDWCZi7cSKB6X1drO8Q3b4kvgTM-pMJf3zA8qWfml5cScMkhVU';
			window.addEventListener('load', function() {
				if ('serviceWorker' in navigator && 'PushManager' in window) {
					//console.log('Service Worker and Push is supported');
					navigator.serviceWorker.register('../service-worker.js').then(function(swReg) {
						//console.log('Service Worker is registered', swReg);

						if (swReg) {

							if (Notification.permission === 'denied') {
								console.log('Push Messaging Blocked.');
								return;
							}

							const applicationServerKey = urlB64ToUint8Array(PUBLIC_VAPID_KEY);
							swReg.pushManager.subscribe({
								userVisibleOnly: true,
								applicationServerKey: applicationServerKey
							}).then(function(subscription) {
								//console.log('User is subscribed:', subscription);

								subscriber(subscription).then();

							}).catch(function(err) {
								console.log('Failed to subscribe the user: ', err);
							});
						}

					}).catch(function(error) {
						console.error('Service Worker Error', error);
					});
				} else {
					console.warn('Push messaging is not supported');
				}
			});
		})();
	</script>

</body>
</html>