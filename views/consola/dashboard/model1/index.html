<div id="dashboard">
	<style>
		.gauge {
			width: 290px;
			height: 220px;
		}
		.gauge-unit {
			opacity: 0.8;
			justify-items: center;
			font-size: 25px;
		}
		.gauge-unit::after {
			content: "%";
			font-size: medium;
		}
		.card-values-grid {
			display: grid;
			grid-template-columns: 50% 50%;
			justify-items: center;
		}
		.card-values-grid h1 {
			margin-bottom: 35px;
		}
		.card-values-grid p {
			margin-bottom: 0;
		}
		.card-value-volt::after{
			content: "V";
			font-size: medium;
		}
		.card-value-amp::after{
			content: "A";
			font-size: medium;
		}
		.card-value-fre::after{
			content: "Hz";
			font-size: medium;
		}
		.switchBtn {
			position: relative;
			display: inline-block;
			margin-top: 8px;
			width: 110px;
			height: 34px;
		}
		.switchBtn input {display:none;}
		.slide {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color:var(--success);
			-webkit-transition: .4s;
			transition: .4s;
			padding: 5px;
			padding-left: 8px;
			color: #fff;
			border-radius: 34px;
		}
		.slide::before {
			position: absolute;
			content: "";
			height: 26px;
			width: 26px;
			left: 78px;
			bottom: 4px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
			border-radius: 50%;
		}
		input:checked + .slide {
			background-color: var(--danger);
			padding-left: 35px;
		}
		input:checked + .slide::before {
			-webkit-transform: translateX(26px);
			-ms-transform: translateX(26px);
			transform: translateX(26px);
			left: -20px;
		}
	</style>
	<!-- Content Header (Page header) -->
	<div class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1>Tablero</h1>
				</div><!-- /.col -->
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li id="tablerodevicenameli" class="breadcrumb-item active"></li>
						<script>document.getElementById("tablerodevicenameli").innerHTML='<a><i class="fa fa-laptop"></i> '+DEVICE_NAME+'</a>';</script>
					</ol>
				</div><!-- /.col -->
			</div><!-- /.row -->
		</div><!-- /.container-fluid -->
	</div><!-- /.content-header -->

	<!-- Main content -->
	<div id="dashboard_contend" class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<div class="d-flex justify-content-between">
								<h3 class="card-title">Conecciones y distribuciones</h3>
							</div>
						</div>
						<div class="card-body">
							<div class="d-flex justify-content-center chart">
								<svg id="connectionChart" width="320" height="320" version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>
							</div>
						</div>
					</div><!-- /.card -->
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h3 class="card-title">Información general</h3>
						</div>
						<div class="card-body">
							<div class="card-values-grid">
								<p>Voltaje en F1</p>
								<p>Voltaje en F2</p>
								<h1 class="card-value-volt">120.2</h1>
								<h1 class="card-value-volt">120.1</h1>
								
								<p>Corriente en F1</p>
								<p>Corriente en F2</p>
								<h1 class="card-value-amp">12.2</h1>
								<h1 class="card-value-amp">13.1</h1>
								
								<p>Frecuencia en fases</p>
								<p>Estado actual</p>
								<h1 class="card-value-fre">59.9</h1>
								<label class="switchBtn">
										<input type="checkbox">
										<div class="slide">Encendid</div>
								</label>
								
							</div>
						</div>
					</div><!-- /.card -->
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h5 class="card-title">Nivel de carga en F1</h5>
						</div> <!-- /.card-header -->
						<div class="card-body">
							<div class="d-flex justify-content-center">
								<div id="LoadF1" class="gauge"></div>
							</div> <!-- /.chart-responsive -->
						</div>
					</div> <!-- /.card -->
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
					<div class="card-header">
					<h5 class="card-title">Nivel de carga en F2</h5>

					</div>
					<!-- /.card-header -->
					<div class="card-body">

					<div class="d-flex justify-content-center">
					<!-- Sales Chart Canvas -->
						<div id="LoadF2" class="gauge"></div>
					</div>
					<!-- /.chart-responsive -->

					</div>
					</div>
				</div>

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
					<div class="card-header">
					<h5 class="card-title">Potencia en F1</h5>
					</div>
					<!-- /.card-header -->
					<div class=" card-body p-0">
						<div id="container-ap"></div>
					</div>
					</div>
				</div>
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">

					<div class="card card-outline card-dark">
					<div class="card-header">
					<h5 class="card-title">Potencia en F2</h5>

					</div>
					<!-- /.card-header -->
					<div class="card-body p-0">

					<div class="chart ">
					<!-- Sales Chart Canvas -->
						<div id="container-ac"></div>
					</div>
					<!-- /.chart-responsive -->

					</div>
					</div>

				</div>
			</div>
		</div>
		<!-- /.container-fluid -->
	</div>
	<!-- /.content -->

	<script type="text/javascript">

		$("input[data-bootstrap-switch]").each(function(){
		$(this).bootstrapSwitch('state', $(this).prop('checked'));
	})

		let connectGraphNodes = [
			{
				name : 'panel',
				color : "#616161",
				image : "../images/pv.svg",
				gauge : 1,
				position : {
					x : 20,
					y : 20
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'bateria',
				color : "#616161",
				image : "../images/battery.svg",
				gauge : 1,
				position : {
					x : 80,
					y : 20
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'inversor',
				color : "#616161",
				image : "../images/inverter.svg",
				gauge : 1,
				position : {
					x : 50,
					y : 50
				},
				connection : {
					x : 80,
					y : 80
				}
			},{
				name : 'red',
				color : "#616161",
				image : "../images/grid.svg",
				gauge : 0,
				position : {
					x : 20,
					y : 80
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'carga',
				color : "#616161",
				image : "../images/consumption.svg",
				gauge : 0,
				position : {
					x : 80,
					y : 80
				},
			}
		]
		let graphic = ConnectionGraph.chart("connectionChart", connectGraphNodes);

		function getRandomInt(min, max) {
			return Math.floor(Math.random() * (max - min)) + min;
		}

		let AP = Highcharts.stockChart('container-ap', {
			time: {
				useUTC: false
			},
			credits: {
				enabled: false
			},
			rangeSelector: {
				buttons: [{
					count: 1,
					type: 'minute',
					text: '1 M'
				}, {
					count: 5,
					type: 'minute',
					text: '5 M'
				}, {
					count: 10,
					type: 'minute',
					text: '10 M'
				}],
				inputEnabled: false,
				selected: 0
			},
			exporting: {
				enabled: false
			},
			yAxis: {
				title: {
					text: ''
				},
				plotLines: [{
					value: 75,
					color: 'red',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Limite de consumo maximo' }
				}, {
					value: 50,
					color: 'yellow',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Última mitad hasta maximo' }
				}]
			},
			series: [{
				name: 'Potencia en F1',
				type: 'area',
				threshold: null,
				fillColor: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0, Highcharts.getOptions().colors[0]],
						[1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
					]
				},
				data: (function () {
					// generate an array of random data
					let data = [];
					let time = (new Date()).getTime();
					let i;

					for (i = -600; i <= 0; i += 1) {
						data.push([
							time + i * 1000,
							//0
							getRandomInt(50, 75)
						]);
					}
					return data;
				}())
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						chart: {
							height: 300
						},
						subtitle: {
							text: null
						},
						navigator: {
							enabled: false
						}
					}
				}]
			}
		});
		let AC = Highcharts.stockChart('container-ac', {
			time: {
				useUTC: false
			},
			credits: {
				enabled: false
			},
			rangeSelector: {
				buttons: [{
					count: 1,
					type: 'minute',
					text: '1 M'
				}, {
					count: 5,
					type: 'minute',
					text: '5 M'
				}, {
					count: 10,
					type: 'minute',
					text: '10 M'
				}],
				inputEnabled: false,
				selected: 0
			},
			exporting: {
				enabled: false
			},
			yAxis: {
				title: {
					text: ''
				},
				plotLines: [{
					value: 75,
					color: 'red',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Limite de consumo maximo' }
				}, {
					value: 50,
					color: 'yellow',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Última mitad hasta maximo' }
				}]
			},
			series: [{
				name: 'Potencia en F2',
				type: 'area',
				threshold: null,
				fillColor: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0, Highcharts.getOptions().colors[0]],
						[1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
					]
				},
				data: (function () {
					// generate an array of random data
					let data = [];
					let time = (new Date()).getTime();
					let i;

					for (i = -600; i <= 0; i += 1) {
						data.push([
							time + i * 1000,
							//0
							getRandomInt(50, 75)
						]);
					}
					return data;
				}())
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						chart: {
							height: 300
						},
						subtitle: {
							text: null
						},
						navigator: {
							enabled: false
						}
					}
				}]
			}
		});

		let gaugeVoltsOptions = {
			chart: {
				type: 'solidgauge'
			},
			title: null,
			pane: {
				center: ['50%', '85%'],
				size: '140%',
				startAngle: -90,
				endAngle: 90,
				background: {
					backgroundColor: Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
					innerRadius: '60%',
					outerRadius: '100%',
					shape: 'arc'
				}
			},
			tooltip: {
				enabled: false
			},
			// the value axis
			yAxis: {
				stops: [
					[0.1, '#55BF3B'], // green
					[0.8, '#DDDF0D'], // yellow
					[0.9, '#DF5353'] // red
				],
				lineWidth: 0,
				minorTickInterval: null,
				tickAmount: 2,
				title: {
					y: -70
				},
				labels: {
					y: 16
				}
			},
			plotOptions: {
				solidgauge: {
					dataLabels: {
						y: 5,
						borderWidth: 0,
						useHTML: true
					}
				}
			}
		};
		let chartvolt = Highcharts.chart('LoadF2', Highcharts.merge(gaugeVoltsOptions, {
			exporting: {
				enabled: false
			},
			yAxis: {
				min: 0,
				max: 100,
				//title: { text: 'Voltios' }
			},
			credits: {
				enabled: false
			},
			series: [{
				name: 'Voltios',
				data: [0],
				dataLabels: {
					format: '<span class="gauge-unit">{y}</span><br/>'
				},
				tooltip: {
					valueSuffix: ' V'
				}
			}]
		}));

		let gaugeAmpsOptions = {
			chart: {
				type: 'solidgauge'
			},
			title: null,
			pane: {
				center: ['50%', '85%'],
				size: '140%',
				startAngle: -90,
				endAngle: 90,
				background: {
					backgroundColor: Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
					innerRadius: '60%',
					outerRadius: '100%',
					shape: 'arc'
				}
			},
			tooltip: {
				enabled: false
			},
			// the value axis
			yAxis: {
				stops: [
					[0.1, '#55BF3B'], // green
					[0.8, '#DDDF0D'], // yellow
					[0.9, '#DF5353'] // red
				],
				lineWidth: 0,
				minorTickInterval: null,
				tickAmount: 2,
				title: {
					y: -70
				},
				labels: {
					y: 16
				}
			},
			plotOptions: {
				solidgauge: {
					dataLabels: {
						y: 5,
						borderWidth: 0,
						useHTML: true
					}
				}
			}
		};
		let chartcurrent = Highcharts.chart('LoadF1', Highcharts.merge(gaugeAmpsOptions, {
			exporting: {
				enabled: false
			},
			yAxis: {
				min: 0,
				max: 100,
				//title: { text: 'Amperios' }
			},
			credits: {
				enabled: false
			},
			series: [{
				name: 'Amperios',
				data: [0],
				dataLabels: {
					format: '<span class="gauge-unit" style="font-size:25px">{y}</span><br/>'
				},
				tooltip: {
					valueSuffix: ' A'
				}
			}]
		}));

		setInterval(function(){

			if (chartvolt) {
				let point = chartvolt.series[0].points[0];
				point.update(getRandomInt(70, 90));
			}

			if (chartcurrent) {
				let point = chartcurrent.series[0].points[0];
				point.update(getRandomInt(70, 90));
			}

			if (AP) {
				let series = AP.series[0];
				let x = (new Date()).getTime()
				let y = getRandomInt(50, 75);
				series.addPoint([x, y], true, true);
			}

			if (AC) {
				let series = AC.series[0];
				let x = (new Date()).getTime()
				let y = getRandomInt(50, 75);
				series.addPoint([x, y], true, true);
			}

			//c = "#00c853"; Verde
			//c = "#9e9e9e"; Gris
			//c = "#616161"; Gris oscuro
			//c = "#d50000"; Rojo
			// id valor direccion color-circulos radio-circulos color-centro

			graphic.updateNode(0, getRandomInt(10, 5), 1, "#00c853", 50);  // Panel a inversor
			graphic.updateNode(1, 30, 0, "#00c853", 50);  // bateria a inversor
			graphic.updateNode(2, 0, 1, "#d50000", 70, "#d50000");  // Inversor a carga
			graphic.updateNode(3, 0, 1, "#d50000", 70);// red a inversor

		}, 3000);

		function DeviceDataProcess (data) {

			console.log(data[0]);

			/*if (chartvolt) {
				let point = chartvolt.series[0].points[0];
				point.update(data[0].value);
			}

			if (chartcurrent) {
				let point = chartcurrent.series[0].points[0];
				point.update(data[0].C);
			}

			if (AP) {
				let series = AP.series[0];
				let x = (new Date()).getTime()
				let y = data[0].AP
				series.addPoint([x, y], true, true);
			}

			if (AC) {
				let series = AC.series[0];
				let x = (new Date()).getTime()
				let y = data[0].AC
				series.addPoint([x, y], true, true);
			}*/
		}

		let wasConnected = false;
		let isConnected = false;
		function connect() {
			// if user is running mozilla then use it's built-in WebSocket
			window.WebSocket = window.WebSocket || window.MozWebSocket;
			if (window.WebSocket) {

				let protocol = 'wss'
				if (location.protocol == 'http:') {protocol = 'ws'}

				// variable connection declarada en el archivo principal.
				connection = new WebSocket(protocol +'://'+ window.location.hostname + '?value=' + v + "&type=user");
				connection.onopen = () => {
					if (wasConnected) {
						toastr.success('Hemos recuperado la comunicacion con el servidor.', 'Éxito!');
					}
					wasConnected = true;
					isConnected = true;
				};
				connection.onmessage = (message) => {
					//console.log(message);
					try {
						var json = JSON.parse(message.data);
						//console.log(json);
						DeviceDataProcess(json);
					} catch (e) {
						console.log('Invalid JSON: ', message.data);
						return;
					}
				};
				connection.onclose = (closeEvent) => {
					if (isConnected) {
						toastr.error('Lo sentimos, Hemos perdido comunicacion con el servidor. Intentando reconectar...', 'Error!');
						isConnected = false;
					}
					setTimeout ('connect()', 5000);
				};
				connection.onerror = (error) => {
					if (isConnected) {
						toastr.error('Lo sentimos, Hay algún problema con la conexión. Intentando reconectar...', 'Error!');
						wasConnected = true;
						isConnected = false;
					}
					connection.close();
				};
			} else {
				toastr.error('Lo sentimos, pero su navegador no es compatible con nuestros sitio web.', 'Error!');
			}
		}
		connect();
	</script>
</div>