<div id="dashboard">
	<style>
		.gauge {
			width: 300px;
    	height: 200px;
		}
		.gauge-unit {
			opacity: 0.8;
			justify-items: center;
			font-size: 25px;
		}
		.gauge-unit::after {
			content: "%";
			font-size: medium;
		}
		.card-grid-values {
			display: grid;
			grid-template-columns: 50% 50%;
			justify-items: center;
		}
		.card-grid-values h1 {
			margin-bottom: 35px;
		}
		.card-grid-values p {
			margin-bottom: 0;
		}
		.card-value-volt::after{
			content: "V";
			font-size: medium;
		}
		.card-value-amp::after{
			content: "A";
			font-size: medium;
		}
		.card-value-fre::after{
			content: "Hz";
			font-size: medium;
		}
		.switchBtn {
			position: relative;
			display: inline-block;
			margin-top: 8px;
			width: 110px;
			height: 34px;
		}
		.switchBtn input {display:none;}
		.slide {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: gray;
			-webkit-transition: .4s;
			transition: .4s;
			padding: 5px;
			padding-left: 8px;
			color: #fff;
			border-radius: 34px;
		}
		.slide::before {
			position: absolute;
			content: "";
			height: 26px;
			width: 26px;
			left: 78px;
			bottom: 4px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
			border-radius: 50%;
		}
		input:checked + .slide {
			background-color: var(--danger);
			padding-left: 35px;
		}
		input:checked + .slide::before {
			-webkit-transform: translateX(26px);
			-ms-transform: translateX(26px);
			transform: translateX(26px);
			left: -20px;
		}
	</style>
	<!-- Content Header (Page header) -->
	<div class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1>Tablero</h1>
				</div><!-- /.col -->
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li id="tablerodevicenameli" class="breadcrumb-item active"></li>
						<script>document.getElementById("tablerodevicenameli").innerHTML='<a><i class="fa fa-laptop"></i> '+DEVICE_NAME+'</a>';</script>
					</ol>
				</div><!-- /.col -->
			</div><!-- /.row -->
		</div><!-- /.container-fluid -->
	</div><!-- /.content-header -->

	<!-- Main content -->
	<div id="dashboard_contend" class="content">
		<div class="container-fluid">
			<div class="row">

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<div class="d-flex justify-content-between">
								<h3 class="card-title">Conecciones y distribuciones</h3>
							</div>
						</div><!-- /.card header -->
						<div class="card-body">
							<div class="d-flex justify-content-center chart">
								<svg id="connectionChart" width="320" height="320" version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>
							</div>
						</div><!-- /.card body -->
					</div><!-- /.card -->
				</div><!-- /.col -->

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h3 class="card-title">Información general</h3>
						</div><!-- /.card header -->
						<div class="card-body">
							<div class="card-grid-values">
								<p>Voltaje en F1</p>
								<p>Voltaje en F2</p>
								<h1 class="card-value-volt" id="voltF1">0</h1>
								<h1 class="card-value-volt" id="voltF2">0</h1>
								
								<p>Corriente en F1</p>
								<p>Corriente en F2</p>
								<h1 class="card-value-amp" id="currentF1">0</h1>
								<h1 class="card-value-amp" id="currentF2">0</h1>
								
								<p>Frecuencia en fases</p>
								<p>Estado actual</p>
								<h1 class="card-value-fre" id="freq">0</h1>
								<label class="switchBtn">
										<input type="checkbox" id="control" onclick="controlClick()">
										<div class="slide" id="controlTitle">- - - - - -</div>
								</label>
							</div><!-- /.card grid values-->
						</div><!-- /.card body -->
					</div><!-- /.card -->
				</div><!-- /.col -->

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h5 class="card-title">Nivel de carga en F1</h5>
						</div> <!-- /.card-header -->
						<div class="card-body d-flex justify-content-center">
							<div id="LoadF1" class="gauge"></div><!-- /.chart-responsive -->
						</div>
					</div> <!-- /.card -->
				</div><!-- /.col -->

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h5 class="card-title">Nivel de carga en F2</h5>
						</div><!-- /.card-header -->
						<div class="card-body d-flex justify-content-center">
							<div id="LoadF2" class="gauge"></div><!-- /.chart-responsive -->
						</div><!-- /.card body -->
					</div><!-- /.card -->
				</div><!-- /.col -->

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h5 class="card-title">Potencia en F1</h5>
						</div><!-- /.card-header -->
						<div class=" card-body p-0">
							<div id="WattsF1"></div>
						</div><!-- /.card body -->
					</div><!-- /.card -->
				</div><!-- /.col -->

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
					<div class="card card-outline card-dark">
						<div class="card-header">
							<h5 class="card-title">Potencia en F2</h5>
						</div><!-- /.card-header -->
						<div class="card-body p-0">
							<div id="WattsF2"></div><!-- /.chart-responsive -->
						</div><!-- /.card body -->
					</div><!-- /.card -->
				</div><!-- /.col -->

			</div><!-- /.row -->
		</div><!-- /.container-fluid -->
	</div><!-- /.content -->

	<script type="text/javascript">

		let voltF1 = document.getElementById("voltF1");
		let voltF2 = document.getElementById("voltF2");

		let currentF1 = document.getElementById("currentF1");
		let currentF2 = document.getElementById("currentF2");

		let Freq = document.getElementById("freq");

		let controlSwitch = document.getElementById("control");
		let controlTitle = document.getElementById("controlTitle");

		let changeState = true; // Se debe cambiar el valor a true para permitir cambiar nuevamente

		function controlClick() {
			changeState = false;
			controlSwitch.disabled = true;
			if (!controlSwitch.checked) {
				controlTitle.innerHTML = "Encendid";
				controlTitle.style.backgroundColor = "#28a745";
			} else {
				controlTitle.innerHTML = "Apagado";
				controlTitle.style.backgroundColor = "#dc3545";
			}

			toastr.info('Enviando orden.');

			setTimeout (function() {
				toastr.success("Orden enviada con exito.");
				controlSend();
			}, 3000);

		}

		// Funcion de confirmacion de recibido
		function controlSend() {
			changeState = true;
		}

		function controlState(state) {
			if (changeState) {
				if (state == "on") {
					controlTitle.innerHTML = "Encendid";
					controlTitle.style.backgroundColor = "#28a745";
					controlSwitch.checked = false;
					controlSwitch.disabled = false;
				} else if (state == "off") {
					controlTitle.innerHTML = "Apagado";
					controlTitle.style.backgroundColor = "#dc3545";
					controlSwitch.checked = true;
					controlSwitch.disabled = false;
				} else {
					controlTitle.innerHTML = "- - - - - -";
					controlTitle.style.backgroundColor = "gray";
					controlSwitch.checked = true;
					controlSwitch.disabled = true;
				}
			}
		}

		function getRandomInt(min, max) {
			return Math.round(Math.random() * (max - min)) + min;
		}

		function getRandomFloat(min, max) {
			return (Math.random() * (max - min) + min).toFixed(1);
		}

		let connectGraphNodes = [
			{
				name : 'panel',
				color : "#616161",
				image : "../images/pv.svg",
				gauge : 1,
				position : {
					x : 20,
					y : 20
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'bateria',
				color : "#616161",
				image : "../images/battery.svg",
				gauge : 1,
				position : {
					x : 80,
					y : 20
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'inversor',
				color : "#616161",
				image : "../images/inverter.svg",
				gauge : 1,
				position : {
					x : 50,
					y : 50
				},
				connection : {
					x : 80,
					y : 80
				}
			},{
				name : 'red',
				color : "#616161",
				image : "../images/grid.svg",
				gauge : 0,
				position : {
					x : 20,
					y : 80
				},
				connection : {
					x : 50,
					y : 50
				}
			},{
				name : 'carga',
				color : "#616161",
				image : "../images/consumption.svg",
				gauge : 0,
				position : {
					x : 80,
					y : 80
				},
			}
		]
		let graphic = ConnectionGraph.chart("connectionChart", connectGraphNodes);

		let wattsF1 = Highcharts.stockChart('WattsF1', {
			time: {
				useUTC: false
			},
			credits: {
				enabled: false
			},
			rangeSelector: {
				buttons: [{
					count: 1,
					type: 'minute',
					text: '1 M'
				}, {
					count: 5,
					type: 'minute',
					text: '5 M'
				}, {
					count: 10,
					type: 'minute',
					text: '10 M'
				}],
				inputEnabled: false,
				selected: 0
			},
			exporting: {
				enabled: false
			},
			yAxis: {
				title: {
					text: ''
				},
				plotLines: [{
					value: 75,
					color: 'red',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Limite de consumo maximo' }
				}, {
					value: 50,
					color: 'yellow',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Última mitad hasta maximo' }
				}]
			},
			series: [{
				name: 'Potencia en F1',
				type: 'area',
				threshold: null,
				fillColor: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0, Highcharts.getOptions().colors[0]],
						[1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
					]
				},
				data: (function () {
					// generate an array of random data
					let data = [];
					let time = (new Date()).getTime();
					let i;

					for (i = -600; i <= 0; i += 1) {
						data.push([
							time + i * 1000,
							//0
							getRandomInt(50, 75)
						]);
					}
					return data;
				}())
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						chart: {
							height: 300
						},
						subtitle: {
							text: null
						},
						navigator: {
							enabled: false
						}
					}
				}]
			}
		});
		let wattsF2 = Highcharts.stockChart('WattsF2', {
			time: {
				useUTC: false
			},
			credits: {
				enabled: false
			},
			rangeSelector: {
				buttons: [{
					count: 1,
					type: 'minute',
					text: '1 M'
				}, {
					count: 5,
					type: 'minute',
					text: '5 M'
				}, {
					count: 10,
					type: 'minute',
					text: '10 M'
				}],
				inputEnabled: false,
				selected: 0
			},
			exporting: {
				enabled: false
			},
			yAxis: {
				title: {
					text: ''
				},
				plotLines: [{
					value: 75,
					color: 'red',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Limite de consumo maximo' }
				}, {
					value: 50,
					color: 'yellow',
					dashStyle: 'shortdash',
					width: 2,
					label: { text: 'Última mitad hasta maximo' }
				}]
			},
			series: [{
				name: 'Potencia en F2',
				type: 'area',
				threshold: null,
				fillColor: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0, Highcharts.getOptions().colors[0]],
						[1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
					]
				},
				data: (function () {
					// generate an array of random data
					let data = [];
					let time = (new Date()).getTime();
					let i;

					for (i = -600; i <= 0; i += 1) {
						data.push([
							time + i * 1000,
							//0
							getRandomInt(50, 75)
						]);
					}
					return data;
				}())
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						chart: {
							height: 300
						},
						subtitle: {
							text: null
						},
						navigator: {
							enabled: false
						}
					}
				}]
			}
		});

		let gaugeLoadOptions = {
			chart: {
				type: 'solidgauge'
			},
			title: null,
			pane: {
				center: ['50%', '85%'],
				size: '140%',
				startAngle: -90,
				endAngle: 90,
				background: {
					backgroundColor: Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
					innerRadius: '60%',
					outerRadius: '100%',
					shape: 'arc'
				}
			},
			tooltip: {
				enabled: false
			},
			// the value axis
			yAxis: {
				stops: [
					[0.1, '#55BF3B'], // green
					[0.8, '#DDDF0D'], // yellow
					[0.9, '#DF5353'] // red
				],
				lineWidth: 0,
				minorTickInterval: null,
				tickAmount: 2,
				title: {
					y: -70
				},
				labels: {
					y: 16
				}
			},
			plotOptions: {
				solidgauge: {
					dataLabels: {
						y: 5,
						borderWidth: 0,
						useHTML: true
					}
				}
			}
		};
		let loadF1 = Highcharts.chart('LoadF1', Highcharts.merge(gaugeLoadOptions, {
			exporting: {
				enabled: false
			},
			yAxis: {
				min: 0,
				max: 100,
			},
			credits: {
				enabled: false
			},
			series: [{
				name: 'Carga F1',
				data: [0],
				dataLabels: {
					format: 
					'<span class="gauge-unit">{y}</span><br/>'+
					'<span style="font-size:12px;opacity:0">%</span>'
				},
				tooltip: {
					valueSuffix: ' %'
				}
			}]
		}));
		let loadF2 = Highcharts.chart('LoadF2', Highcharts.merge(gaugeLoadOptions, {
			exporting: {
				enabled: false
			},
			yAxis: {
				min: 0,
				max: 100,
			},
			credits: {
				enabled: false
			},
			series: [{
				name: 'Carga F2',
				data: [0],
				dataLabels: {
					format: 
					'<span class="gauge-unit" style="font-size:25px">{y}</span><br/>'+
					'<span style="font-size:12px;opacity:0">%</span>'
				},
				tooltip: {
					valueSuffix: ' %'
				}
			}]
		}));

		setInterval (function() {

			voltF1.innerHTML = getRandomFloat(120, 121);
			voltF2.innerHTML = getRandomFloat(120, 121);

			currentF1.innerHTML = getRandomFloat(10, 11);
			currentF2.innerHTML = getRandomFloat(13, 14);

			Freq.innerHTML = getRandomFloat(59.9, 60.1);

			controlState("on");

			if (loadF1) {
				let point = loadF1.series[0].points[0];
				point.update(getRandomInt(70, 90));
			}

			if (loadF2) {
				let point = loadF2.series[0].points[0];
				point.update(getRandomInt(70, 90));
			}

			if (wattsF1) {
				let series = wattsF1.series[0];
				let x = (new Date()).getTime()
				let y = getRandomInt(50, 75);
				series.addPoint([x, y], true, true);
			}

			if (wattsF2) {
				let series = wattsF2.series[0];
				let x = (new Date()).getTime()
				let y = getRandomInt(50, 75);
				series.addPoint([x, y], true, true);
			}

			//c = "#00c853"; Verde
			//c = "#9e9e9e"; Gris
			//c = "#616161"; Gris oscuro
			//c = "#d50000"; Rojo
			// id valor direccion color-circulos radio-circulos color-centro

			graphic.updateNode(0, getRandomInt(10, 5), 1, "#00c853", 50);  // Panel a inversor
			graphic.updateNode(1, 30, 0, "#00c853", 50);  // bateria a inversor
			graphic.updateNode(2, 0, 1, "#d50000", 70, "#d50000");  // Inversor a carga
			graphic.updateNode(3, 0, 1, "#d50000", 70);// red a inversor

		}, 3000);

		function DeviceDataProcess (data) {

			console.log(data[0]);

			/*if (loadF1) {
				let point = loadF1.series[0].points[0];
				point.update(data[0].value);
			}

			if (loadF2) {
				let point = loadF2.series[0].points[0];
				point.update(data[0].C);
			}

			if (wattsF1) {
				let series = wattsF1.series[0];
				let x = (new Date()).getTime()
				let y = data[0].wattsF1
				series.addPoint([x, y], true, true);
			}

			if (wattsF2) {
				let series = wattsF2.series[0];
				let x = (new Date()).getTime()
				let y = data[0].wattsF2
				series.addPoint([x, y], true, true);
			}*/
		}

		let wasConnected = false;
		let isConnected = false;
		function connect() {
			// if user is running mozilla then use it's built-in WebSocket
			window.WebSocket = window.WebSocket || window.MozWebSocket;
			if (window.WebSocket) {

				let protocol = 'wss'
				if (location.protocol == 'http:') {protocol = 'ws'}

				// variable connection declarada en el archivo principal.
				connection = new WebSocket(protocol +'://'+ window.location.hostname + '?value=' + v + "&type=user");
				connection.onopen = () => {
					if (wasConnected) {
						toastr.success('Hemos recuperado la comunicacion con el servidor.', 'Éxito!');
					}
					wasConnected = true;
					isConnected = true;
				};
				connection.onmessage = (message) => {
					//console.log(message);
					try {
						var json = JSON.parse(message.data);
						//console.log(json);
						DeviceDataProcess(json);
					} catch (e) {
						console.log('Invalid JSON: ', message.data);
						return;
					}
				};
				connection.onclose = (closeEvent) => {
					if (isConnected) {
						toastr.error('Lo sentimos, Hemos perdido comunicacion con el servidor. Intentando reconectar...', 'Error!');
						isConnected = false;
					}
					setTimeout ('connect()', 5000);
				};
				connection.onerror = (error) => {
					if (isConnected) {
						toastr.error('Lo sentimos, Hay algún problema con la conexión. Intentando reconectar...', 'Error!');
						wasConnected = true;
						isConnected = false;
					}
					connection.close();
				};
			} else {
				toastr.error('Lo sentimos, pero su navegador no es compatible con nuestros sitio web.', 'Error!');
			}
		}
		connect();
	</script>
</div>